#!groovy
properties properties: [buildDiscarder(logRotator(numToKeepStr: '10'))]

pipeline {

    agent any

    environment {
        APPLICATION = "email"
        SERVER_IP = "192.168.104.167"
        SERVER_CREDENTIALS = "s-pep-java-in-test_192.168.104.167"
    }

    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }
        stage("Package") {
            steps {
                sh """
                    mvn package
                    more README.md
                """
            }
        }
        stage("Deploy") {
            steps {
                sh """
                    echo deploy success
                """
            }
        }
    }

    post {
        success {
            sh """
                echo 构建成功
                pwd
                ls -rlt
                sed -i "s/#APPLICATION#/${APPLICATION}/g" jenkins-email.html
                sed -i "s/#JOB_NAME#/${JOB_NAME}/g" jenkins-email.html
                sed -i "s/#BUILD_NUMBER#/${BUILD_NUMBER}/g" jenkins-email.html
            """
            emailext(
                    subject: '[构建成功]: ${env.JOB_NAME} [${env.BUILD_NUMBER}]',
                    body: '${FILE, path="jenkins-email.html"}',
                    to: 'xtazxz@qq.com',
                    from: 'PEP Jenkins <devops@pep.com.cn>'
            )
        }
        failure {
            sh """
                echo 构建失败
                pwd
                ls -rlt
                sed -i "s/#APPLICATION#/${APPLICATION}/g" jenkins-email.html
                sed -i "s/#JOB_NAME#/${JOB_NAME}/g" jenkins-email.html
                sed -i "s/#BUILD_NUMBER#/${BUILD_NUMBER}/g" jenkins-email.html
            """
            emailext(
                    subject: '[构建失败]: ${env.JOB_NAME} [${env.BUILD_NUMBER}]',
                    body: '${FILE, path="jenkins-email.html"}',
                    to: 'xtazxz@qq.com',
                    from: 'PEP Jenkins <devops@pep.com.cn>'
            )
        }
    }

}
