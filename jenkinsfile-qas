#!groovy
properties properties: [buildDiscarder(logRotator(numToKeepStr: '10'))]

pipeline {

    agent any

    environment {
        APPLICATION = "email"
        SERVER_IP = "192.168.104.167"
        SERVER_CREDENTIALS = "s-pep-java-in-test_192.168.104.167"
        SEND_RESULT_TO = "xtazxz@qq.com"
    }

    stages {
        stage("Package") {
            steps {
                checkout scm
                sh """
                    mvn package
                    more README.md
                """
            }
        }
        stage("Deploy") {
            steps {
                sh """
                    echo deploy success
                """
            }
        }
    }

    post {
        always {
            sh """
                sed -i "s#PARAM_JOB_NAME#${JOB_NAME}#g" jenkins-email.template
                sed -i "s#PARAM_BUILD_NUMBER#${BUILD_NUMBER}#g" jenkins-email.template
                sed -i "s#PARAM_RESULT#${currentBuild.result}#g" jenkins-email.template
                sed -i "s#PARAM_BUILD_URL#${BUILD_URL}console#g" jenkins-email.template
                echo '[构建${currentBuild.result}]: ${JOB_NAME} [${BUILD_NUMBER}]'
                echo '${SEND_RESULT_TO}'
            """
            def RESULT = "${currentBuild.result}";
            sh """
                echo "${RESULT}"
            """
            emailext(
                    subject: '[构建${RESULT}]: ${JOB_NAME} [${BUILD_NUMBER}]',
                    body: '${FILE, path="jenkins-email.template"}',
                    to: 'xtazxz@qq.com'
            )
        }
    }

}
