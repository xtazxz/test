#!groovy
properties properties: [buildDiscarder(logRotator(numToKeepStr: '10'))]

pipeline {

    agent any

    environment {
        APPLICATION = "email"
        SERVER_IP = "192.168.104.167"
        SERVER_CREDENTIALS = "s-pep-java-in-test_192.168.104.167"
    }

    stages {
        stage("Package") {
            steps {
                checkout scm
                sh """
                    mvn package
                    more README.md
                """
            }
        }
        stage("Deploy") {
            steps {
                sh """
                    echo deploy success
                """
            }
        }
    }

    post {
        always {
            sh """
                echo "======================================================="
                echo "BRANCH_NAME: ${env.BRANCH_NAME}"
                echo "CHANGE_ID: ${env.CHANGE_ID}"
                echo "CHANGE_URL: ${env.CHANGE_URL}"
                echo "CHANGE_TITLE: ${env.CHANGE_TITLE}"
                echo "CHANGE_AUTHOR: ${env.CHANGE_AUTHOR}"
                echo "CHANGE_AUTHOR_DISPLAY_NAME: ${env.CHANGE_AUTHOR_DISPLAY_NAME}"
                echo "CHANGE_AUTHOR_EMAIL: ${env.CHANGE_AUTHOR_EMAIL}"
                echo "CHANGE_TARGET: ${env.CHANGE_TARGET}"
                echo "CHANGE_BRANCH: ${env.CHANGE_BRANCH}"
                echo "TAG_NAME: ${env.TAG_NAME}"
                echo "JOB_DISPLAY_URL: ${env.JOB_DISPLAY_URL}"
                echo "RUN_DISPLAY_URL: ${env.RUN_DISPLAY_URL}"
                echo "BUILD_NUMBER: ${env.BUILD_NUMBER}"
                echo "BUILD_ID: ${env.BUILD_ID}"
                echo "BUILD_DISPLAY_NAME: ${env.BUILD_DISPLAY_NAME}"
                echo "JOB_NAME: ${env.JOB_NAME}"
                echo "JOB_BASE_NAME: ${env.JOB_BASE_NAME}"
                echo "BUILD_TAG: ${env.BUILD_TAG}"
                echo "BUILD_URL: ${env.BUILD_URL}"
                echo "JOB_URL: ${env.JOB_URL}"
                echo "======================================================="
                echo "result: ${currentBuild.result}"
                echo "currentResult: ${currentBuild.currentResult}"
                echo "displayName: ${currentBuild.displayName}"
                echo "fullDisplayName: ${currentBuild.fullDisplayName}"
                echo "projectName: ${currentBuild.projectName}"
                echo "fullProjectName: ${currentBuild.fullProjectName}"
                echo "description: ${currentBuild.description}"
                echo "id: ${currentBuild.id}"
                echo "timeInMillis: ${currentBuild.timeInMillis}"
                echo "startTimeInMillis: ${currentBuild.startTimeInMillis}"
                echo "duration: ${currentBuild.duration}"
                echo "durationString: ${currentBuild.durationString}"
                echo "absoluteUrl: ${currentBuild.absoluteUrl}"
                echo "buildVariables: ${currentBuild.buildVariables}"
                echo "changeSets: ${currentBuild.changeSets}"
                echo "======================================================="
            """
            sh """
                sed -i "s#PARAM_JOB_NAME#${JOB_BASE_NAME}#g" jenkins-email.template
                sed -i "s#PARAM_BUILD_NUMBER#${BUILD_NUMBER}#g" jenkins-email.template
                sed -i "s#PARAM_RESULT#${currentBuild.result}#g" jenkins-email.template
                sed -i "s#PARAM_BUILD_URL#${BUILD_URL}console#g" jenkins-email.template
            """
            emailext(
                    subject: '[构建${currentBuild.result}]: ${JOB_NAME} [${BUILD_NUMBER}]',
                    body: '${FILE, path="jenkins-email.template"}',
                    to: 'xtazxz@qq.com'
            )
        }
    }

}
